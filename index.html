<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agro Consultoria - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{--primary:#10b981;--primary-dark:#059669;--secondary:#3b82f6;--bg-dark:#1e293b;--bg-darker:#0f172a;--bg-card:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--border:#475569;--success:#22c55e;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg-darker);color:var(--text-primary);min-height:100vh;-webkit-tap-highlight-color:transparent}
        
        /* ===== LAYOUT PRINCIPAL ===== */
        .app-container{display:flex;min-height:100vh}
        
        /* ===== SIDEBAR DESKTOP ===== */
        .sidebar{width:240px;background:var(--bg-dark);border-right:1px solid var(--border);position:fixed;height:100vh;z-index:100;display:flex;flex-direction:column;transition:transform .3s}
        .sidebar-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
        .sidebar-logo{width:36px;height:36px;background:linear-gradient(135deg,var(--primary),var(--secondary));border-radius:8px;display:flex;align-items:center;justify-content:center}
        .sidebar-brand{font-size:18px;font-weight:700;color:var(--primary)}
        .sidebar-nav{flex:1;padding:15px}
        .nav-item{display:flex;align-items:center;gap:12px;padding:12px 15px;color:var(--text-secondary);text-decoration:none;border-radius:8px;margin-bottom:4px}
        .nav-item:hover{background:var(--bg-card);color:var(--text-primary)}
        .nav-item.active{background:var(--primary);color:white}
        .nav-item i{width:20px}
        .sidebar-close{display:none;position:absolute;top:15px;right:15px;background:none;border:none;color:var(--text-primary);font-size:24px;cursor:pointer}
        
        /* ===== MAIN CONTENT ===== */
        .main-content{flex:1;margin-left:240px;padding:20px}
        
        /* ===== MOBILE HEADER ===== */
        .mobile-header{display:none;position:fixed;top:0;left:0;right:0;background:var(--bg-dark);padding:12px 15px;z-index:90;border-bottom:1px solid var(--border);align-items:center;justify-content:space-between}
        .mobile-header-left{display:flex;align-items:center;gap:10px}
        .menu-toggle{background:none;border:none;color:var(--text-primary);font-size:22px;cursor:pointer;padding:5px}
        .mobile-title{font-size:16px;font-weight:600;color:var(--primary)}
        .mobile-header-right{display:flex;gap:8px}
        .mobile-btn{width:40px;height:40px;border-radius:8px;border:none;background:var(--bg-card);color:var(--text-primary);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        
        /* ===== OVERLAY MOBILE ===== */
        .sidebar-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:99}
        .sidebar-overlay.show{display:block}
        
        /* ===== PAGE HEADER ===== */
        .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px}
        .page-title{font-size:22px;font-weight:600}
        .header-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        .unit-toggle{display:flex;background:var(--bg-card);border-radius:6px;overflow:hidden}
        .unit-btn{padding:8px 14px;border:none;background:transparent;color:var(--text-secondary);cursor:pointer;font-size:12px}
        .unit-btn.active{background:var(--primary);color:white}
        .btn{padding:10px 18px;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;display:inline-flex;align-items:center;gap:8px;transition:all .2s}
        .btn-primary{background:var(--primary);color:white}
        .btn-primary:hover{background:var(--primary-dark)}
        .btn-secondary{background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border)}
        .btn-secondary:hover{background:var(--border)}
        .btn-icon{width:40px;height:40px;padding:0;justify-content:center}
        
        /* ===== DASHBOARD GRID ===== */
        .dashboard-grid{display:grid;grid-template-columns:1fr 380px;gap:20px;margin-bottom:20px}
        
        /* ===== MAP ===== */
        .map-container{background:var(--bg-card);border-radius:12px;overflow:hidden;height:480px;position:relative}
        #map{width:100%;height:100%}
        .map-controls{position:absolute;top:10px;right:10px;z-index:1000;display:flex;flex-direction:column;gap:4px}
        .map-control-btn{background:var(--bg-dark);border:1px solid var(--border);color:var(--text-primary);padding:6px 10px;border-radius:4px;cursor:pointer;font-size:11px}
        .map-control-btn.active{background:var(--primary);border-color:var(--primary)}
        .map-display-controls{position:absolute;bottom:10px;left:10px;z-index:1000;display:flex;gap:4px;background:var(--bg-dark);padding:6px;border-radius:8px;border:1px solid var(--border)}
        .map-display-btn{width:36px;height:36px;border:none;border-radius:6px;background:var(--bg-card);color:var(--text-secondary);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .2s}
        .map-display-btn:hover{color:var(--text-primary);background:var(--border)}
        .map-display-btn.active{background:var(--primary);color:white}
        .station-marker{background:transparent!important;border:none!important}
        
        /* ===== WEATHER WIDGET ===== */
        .weather-widget{background:linear-gradient(135deg,var(--bg-card),var(--bg-dark));border-radius:12px;padding:18px}
        .widget-header{margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;gap:10px}
        .widget-header select{flex:1;padding:10px;background:var(--bg-dark);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:13px}
        .widget-header-btns{display:flex;gap:6px}
        .widget-icon-btn{width:36px;height:36px;border:none;border-radius:8px;background:var(--bg-dark);color:var(--text-secondary);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
        .widget-icon-btn:hover{color:var(--text-primary);background:var(--border)}
        .auto-sync-indicator{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--success);margin-top:8px}
        .auto-sync-indicator.off{color:var(--text-secondary)}
        .weather-main{text-align:center;padding:20px 0;border-bottom:1px solid var(--border)}
        .weather-icon{font-size:48px;margin-bottom:8px}
        .weather-temp{font-size:56px;font-weight:300}
        .weather-feels{font-size:12px;color:var(--text-secondary);margin-top:5px}
        .weather-details{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:15px 0;border-bottom:1px solid var(--border)}
        .weather-detail{display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px;border-radius:6px;transition:background .2s}
        .weather-detail:hover,.weather-detail:active{background:var(--bg-dark)}
        .weather-detail-icon{width:32px;height:32px;background:var(--bg-dark);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px}
        .weather-detail-value{font-size:14px;font-weight:600}
        .weather-detail-label{font-size:10px;color:var(--text-secondary)}
        .rain-section{padding:15px 0;border-bottom:1px solid var(--border)}
        .rain-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .rain-tabs{display:flex;gap:4px}
        .rain-tab{padding:4px 8px;background:var(--bg-dark);border:none;border-radius:4px;color:var(--text-secondary);cursor:pointer;font-size:10px}
        .rain-tab.active{background:var(--secondary);color:white}
        .rain-display{display:flex;align-items:center;gap:12px}
        .rain-value{font-size:24px;font-weight:700}
        .wind-section{padding:15px 0}
        .wind-rose-container{display:flex;align-items:center;gap:15px}
        .wind-rose{width:70px;height:70px;position:relative}
        .wind-rose-bg{position:absolute;width:100%;height:100%;border-radius:50%;border:2px solid var(--border)}
        .wind-rose-arrow{position:absolute;top:50%;left:50%;width:3px;height:25px;background:var(--primary);transform-origin:bottom center;margin-left:-1.5px;margin-top:-25px;border-radius:2px}
        .wind-rose-center{position:absolute;top:50%;left:50%;width:6px;height:6px;background:var(--primary);border-radius:50%;transform:translate(-50%,-50%)}
        .wind-rose-labels{position:absolute;width:100%;height:100%;font-size:8px;color:var(--text-secondary)}
        .wind-rose-labels span{position:absolute}
        .wind-rose-labels .n{top:2px;left:50%;transform:translateX(-50%)}
        .wind-rose-labels .s{bottom:2px;left:50%;transform:translateX(-50%)}
        .wind-rose-labels .e{right:2px;top:50%;transform:translateY(-50%)}
        .wind-rose-labels .w{left:2px;top:50%;transform:translateY(-50%)}
        .wind-speed{font-size:20px;font-weight:700}
        .wind-gust,.wind-direction{font-size:11px;color:var(--text-secondary)}
        .weather-updated{text-align:center;font-size:10px;color:var(--text-secondary);margin-top:12px}
        
        /* ===== HISTORY SECTION ===== */
        .history-section{background:var(--bg-card);border-radius:12px;padding:18px}
        .history-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px}
        .history-filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        .date-input{padding:8px 10px;background:var(--bg-dark);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:12px}
        .chart-container{height:280px;margin-bottom:15px}
        .summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
        .summary-card{background:var(--bg-dark);border-radius:8px;padding:12px;cursor:pointer;transition:transform .2s}
        .summary-card:hover,.summary-card:active{transform:scale(1.02)}
        .summary-card-title{font-size:11px;color:var(--text-secondary);margin-bottom:6px}
        .summary-card-value{font-size:20px;font-weight:600}
        
        /* ===== SYNC STATUS ===== */
        .sync-status{display:flex;align-items:center;gap:8px;font-size:11px;padding:10px 14px;background:var(--bg-card);border-radius:8px;margin-bottom:12px}
        .sync-status.syncing{color:var(--warning)}
        .sync-status.success{color:var(--success);background:rgba(34,197,94,.1)}
        .sync-status.error{color:var(--danger);background:rgba(239,68,68,.1)}
        
        /* ===== MODALS ===== */
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px}
        .modal-overlay.hidden{display:none}
        .modal{background:var(--bg-dark);border-radius:16px;padding:35px;width:100%;max-width:380px;border:1px solid var(--border);max-height:90vh;overflow-y:auto}
        .modal-logo{text-align:center;margin-bottom:25px}
        .modal-logo i{font-size:42px;color:var(--primary)}
        .modal-logo h1{font-size:24px;margin-top:8px;color:var(--primary)}
        .form-group{margin-bottom:18px}
        .form-group label{display:block;margin-bottom:6px;font-size:13px;color:var(--text-secondary)}
        .form-group input,.form-group select{width:100%;padding:11px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:13px}
        .btn-block{width:100%;justify-content:center}
        
        /* ===== CONFIG MODAL ===== */
        .config-modal{max-width:420px}
        .config-modal h2{font-size:18px;margin-bottom:20px;display:flex;align-items:center;gap:10px}
        .config-section{margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid var(--border)}
        .config-section:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
        .config-section h3{font-size:14px;margin-bottom:12px;color:var(--text-secondary)}
        .config-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0}
        .config-label{font-size:13px}
        .config-label small{display:block;font-size:11px;color:var(--text-secondary);margin-top:2px}
        .toggle-switch{position:relative;width:48px;height:26px}
        .toggle-switch input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--bg-card);border-radius:26px;transition:.3s}
        .toggle-slider:before{position:absolute;content:"";height:20px;width:20px;left:3px;bottom:3px;background:white;border-radius:50%;transition:.3s}
        .toggle-switch input:checked+.toggle-slider{background:var(--primary)}
        .toggle-switch input:checked+.toggle-slider:before{transform:translateX(22px)}
        .config-select{padding:8px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:13px;min-width:100px}
        .config-btn{padding:10px 16px;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;display:flex;align-items:center;gap:8px;width:100%;justify-content:center;margin-top:8px}
        .config-btn-danger{background:var(--danger);color:white}
        .config-btn-secondary{background:var(--secondary);color:white}
        
        /* ===== TOOLTIP ===== */
        .tooltip{position:fixed;background:var(--bg-dark);border:1px solid var(--border);border-radius:8px;padding:12px;font-size:12px;z-index:2000;max-width:200px;box-shadow:0 4px 20px rgba(0,0,0,.3);pointer-events:none}
        .tooltip-title{font-weight:600;margin-bottom:6px}
        .tooltip-value{color:var(--primary);font-size:18px;font-weight:700}
        .tooltip-label{color:var(--text-secondary);font-size:10px}
        
        /* ===== DATA TABLE ===== */
        .data-table{width:100%;border-collapse:collapse;font-size:11px}
        .data-table th,.data-table td{padding:8px 10px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap}
        .data-table th{background:var(--bg-card);font-weight:600;color:var(--text-secondary);text-transform:uppercase;font-size:10px;position:sticky;top:0;z-index:1}
        .data-table tbody tr:hover{background:rgba(255,255,255,.03)}
        .data-table td{color:var(--text-primary)}
        .hidden{display:none!important}
        
        /* ===== TOAST ===== */
        .toast{position:fixed;top:20px;right:20px;padding:12px 20px;background:var(--bg-card);border-radius:8px;border-left:4px solid var(--primary);z-index:2000;font-size:13px;animation:slideIn .3s}
        .toast.error{border-color:var(--danger)}
        .toast.success{border-color:var(--success)}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        
        /* ===== RESPONSIVE - TABLET ===== */
        @media(max-width:1024px){
            .dashboard-grid{grid-template-columns:1fr}
            .map-container{height:350px}
            .summary-grid{grid-template-columns:repeat(2,1fr)}
        }
        
        /* ===== RESPONSIVE - MOBILE ===== */
        @media(max-width:768px){
            .sidebar{transform:translateX(-100%)}
            .sidebar.open{transform:translateX(0)}
            .sidebar-close{display:block}
            .sidebar-overlay.show{display:block}
            .main-content{margin-left:0;padding:70px 12px 20px}
            .mobile-header{display:flex}
            .page-header{display:none}
            .weather-widget{padding:14px}
            .weather-temp{font-size:48px}
            .weather-icon{font-size:38px}
            .weather-details{gap:8px}
            .weather-detail{padding:8px}
            .weather-detail-icon{width:28px;height:28px;font-size:12px}
            .weather-detail-value{font-size:13px}
            .map-container{height:280px}
            .chart-container{height:220px}
            .summary-grid{grid-template-columns:1fr 1fr}
            .summary-card{padding:10px}
            .summary-card-value{font-size:18px}
            .history-filters{width:100%}
            .date-input{flex:1;min-width:0}
            .modal{padding:25px;margin:10px}
            .toast{right:10px;left:10px;text-align:center}
        }
    </style>
</head>
<body>

<!-- ===== LOGIN MODAL ===== -->
<div class="modal-overlay" id="loginModal">
    <div class="modal">
        <div class="modal-logo">
            <i class="fas fa-cloud-sun-rain"></i>
            <h1>Agro Consultoria</h1>
            <p style="color:var(--text-secondary);font-size:13px">Monitoramento MeteorolÃ³gico</p>
        </div>
        <form id="loginForm">
            <div class="form-group"><label>Email</label><input type="email" id="loginEmail" required></div>
            <div class="form-group"><label>Senha</label><input type="password" id="loginPassword" required></div>
            <button type="submit" class="btn btn-primary btn-block"><i class="fas fa-sign-in-alt"></i> Entrar</button>
        </form>
        <p style="text-align:center;margin-top:18px;font-size:12px;color:var(--text-secondary)">
            NÃ£o tem conta? <a href="#" onclick="toggleRegister()" style="color:var(--primary)">Cadastre-se</a>
        </p>
        <form id="registerForm" style="display:none">
            <div class="form-group"><label>Nome</label><input type="text" id="registerName" required></div>
            <div class="form-group"><label>Email</label><input type="email" id="registerEmail" required></div>
            <div class="form-group"><label>Senha</label><input type="password" id="registerPassword" required minlength="6"></div>
            <button type="submit" class="btn btn-primary btn-block"><i class="fas fa-user-plus"></i> Cadastrar</button>
            <p style="text-align:center;margin-top:12px;font-size:12px"><a href="#" onclick="toggleRegister()" style="color:var(--primary)">Voltar</a></p>
        </form>
    </div>
</div>

<!-- ===== CONFIG MODAL ===== -->
<div class="modal-overlay hidden" id="configModal" onclick="if(event.target===this)closeConfig()">
    <div class="modal config-modal">
        <h2><i class="fas fa-cog" style="color:var(--primary)"></i> ConfiguraÃ§Ãµes da EstaÃ§Ã£o</h2>
        
        <div class="config-section">
            <h3><i class="fas fa-ruler"></i> Unidade de Medida</h3>
            <div class="config-row">
                <div class="config-label">Temperatura</div>
                <select class="config-select" id="configTempUnit" onchange="setUnit(this.value)">
                    <option value="metric">Celsius (Â°C)</option>
                    <option value="imperial">Fahrenheit (Â°F)</option>
                </select>
            </div>
        </div>
        
        <div class="config-section">
            <h3><i class="fas fa-database"></i> Dados</h3>
            <div class="config-row">
                <div class="config-label">
                    Importar HistÃ³rico
                    <small>Buscar dados antigos da estaÃ§Ã£o Ecowitt</small>
                </div>
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
                <select class="config-select" id="historyMonths" style="flex:1">
                    <option value="1">1 mÃªs</option>
                    <option value="3">3 meses</option>
                    <option value="6">6 meses</option>
                    <option value="12" selected>12 meses</option>
                    <option value="24">24 meses</option>
                    <option value="0">Tudo (mÃ¡ximo disponÃ­vel)</option>
                </select>
                <button class="btn btn-secondary" onclick="importHistory()" id="historyBtn">
                    <i class="fas fa-download"></i> Importar
                </button>
            </div>
            <div class="config-row" style="margin-top:15px">
                <div class="config-label">
                    ForÃ§ar SincronizaÃ§Ã£o
                    <small>Atualizar dados do servidor</small>
                </div>
                <button class="btn btn-primary btn-icon" onclick="syncEcowitt()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        
        <div class="config-section">
            <h3><i class="fas fa-info-circle"></i> InformaÃ§Ãµes</h3>
            <div class="config-row">
                <div class="config-label">EstaÃ§Ã£o</div>
                <span id="configStationName" style="color:var(--text-secondary)">--</span>
            </div>
            <div class="config-row">
                <div class="config-label">IMEI</div>
                <span id="configStationIMEI" style="color:var(--text-secondary);font-family:monospace;font-size:11px">--</span>
            </div>
            <div class="config-row">
                <div class="config-label">Ãšltima SincronizaÃ§Ã£o</div>
                <span id="configLastSync" style="color:var(--text-secondary);font-size:12px">--</span>
            </div>
        </div>
        
        <button class="btn btn-secondary btn-block" onclick="closeConfig()">
            <i class="fas fa-times"></i> Fechar
        </button>
    </div>
</div>

<!-- ===== SIDEBAR OVERLAY (MOBILE) ===== -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<!-- ===== APP CONTAINER ===== -->
<div class="app-container" id="appContainer" style="display:none">
    
    <!-- ===== MOBILE HEADER ===== -->
    <div class="mobile-header">
        <div class="mobile-header-left">
            <button class="menu-toggle" onclick="openSidebar()"><i class="fas fa-bars"></i></button>
            <span class="mobile-title">Agro Consultoria</span>
        </div>
        <div class="mobile-header-right">
            <button class="mobile-btn" onclick="syncEcowitt()"><i class="fas fa-sync-alt"></i></button>
            <button class="mobile-btn" onclick="openConfig()"><i class="fas fa-cog"></i></button>
        </div>
    </div>
    
    <!-- ===== SIDEBAR ===== -->
    <aside class="sidebar" id="sidebar">
        <button class="sidebar-close" onclick="closeSidebar()"><i class="fas fa-times"></i></button>
        <div class="sidebar-header">
            <div class="sidebar-logo"><i class="fas fa-cloud-sun-rain" style="color:white;font-size:16px"></i></div>
            <span class="sidebar-brand">Agro Consultoria</span>
        </div>
        <nav class="sidebar-nav">
            <a href="index.html" class="nav-item active"><i class="fas fa-chart-line"></i> Dashboard</a>
            <a href="previsao.html" class="nav-item"><i class="fas fa-cloud-sun"></i> PrevisÃ£o</a>
            <a href="relatorios.html" class="nav-item"><i class="fas fa-file-alt"></i> RelatÃ³rios</a>
            <a href="admin.html" class="nav-item" id="adminLink" style="display:none"><i class="fas fa-shield-alt"></i> Admin</a>
            <a href="#" class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</a>
            <div style="margin-top:auto;padding-top:15px;border-top:1px solid var(--border)">
                <a href="index_es.html" class="nav-item" style="justify-content:center"><span style="font-size:16px">ðŸ‡µðŸ‡¾</span> EspaÃ±ol</a>
            </div>
        </nav>
    </aside>
    
    <!-- ===== MAIN CONTENT ===== -->
    <main class="main-content">
        <!-- Page Header (Desktop) -->
        <div class="page-header">
            <h1 class="page-title">Dashboard</h1>
            <div class="header-controls">
                <div class="unit-toggle">
                    <button class="unit-btn active" onclick="setUnit('metric')" id="btn-metric">Â°C</button>
                    <button class="unit-btn" onclick="setUnit('imperial')" id="btn-imperial">Â°F</button>
                </div>
                <button class="btn btn-primary" onclick="syncEcowitt()" id="syncBtnDesktop">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
                <button class="btn btn-secondary btn-icon" onclick="openConfig()" title="ConfiguraÃ§Ãµes">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
        
        <!-- Sync Status -->
        <div id="syncStatus" class="sync-status" style="display:none"></div>
        
        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Map -->
            <div class="map-container">
                <div id="map"></div>
                <div class="map-controls">
                    <button class="map-control-btn" onclick="setMapLayer('street')" id="btn-street">Mapa</button>
                    <button class="map-control-btn active" onclick="setMapLayer('satellite')" id="btn-satellite">SatÃ©lite</button>
                    <button class="map-control-btn" onclick="setMapLayer('terrain')" id="btn-terrain">Terreno</button>
                </div>
                <div class="map-display-controls">
                    <button class="map-display-btn active" onclick="setMapDisplay('temp')" id="map-btn-temp" title="Temperatura"><i class="fas fa-thermometer-half"></i></button>
                    <button class="map-display-btn" onclick="setMapDisplay('rain_day')" id="map-btn-rain_day" title="Chuva Hoje"><i class="fas fa-cloud-sun-rain"></i></button>
                    <button class="map-display-btn" onclick="setMapDisplay('rain_week')" id="map-btn-rain_week" title="Chuva Semana"><i class="fas fa-cloud-rain"></i></button>
                    <button class="map-display-btn" onclick="setMapDisplay('rain_month')" id="map-btn-rain_month" title="Chuva MÃªs"><i class="fas fa-cloud-showers-heavy"></i></button>
                </div>
            </div>
            
            <!-- Weather Widget -->
            <div class="weather-widget">
                <div class="widget-header">
                    <select id="estacaoSelect" onchange="loadEstacaoData()"><option value="">Selecione...</option></select>
                    <div class="widget-header-btns">
                        <button class="widget-icon-btn" onclick="openConfig()" title="ConfiguraÃ§Ãµes"><i class="fas fa-cog"></i></button>
                    </div>
                </div>
                <div class="auto-sync-indicator" id="autoSyncIndicator"><i class="fas fa-server"></i> Sync AutomÃ¡tico</div>
                
                <div class="weather-main">
                    <div class="weather-icon" id="weatherIcon"><i class="fas fa-cloud-sun" style="color:var(--warning)"></i></div>
                    <div class="weather-temp"><span id="currentTemp">--</span><span style="font-size:20px" id="tempUnit">Â°C</span></div>
                    <div class="weather-feels" id="weatherFeels">SensaÃ§Ã£o: --</div>
                </div>
                
                <div class="weather-details">
                    <div class="weather-detail" data-tooltip="Umidade relativa do ar">
                        <div class="weather-detail-icon" style="color:var(--info)"><i class="fas fa-tint"></i></div>
                        <div><div class="weather-detail-value" id="detailHumidity">--%</div><div class="weather-detail-label">Umidade</div></div>
                    </div>
                    <div class="weather-detail" data-tooltip="PressÃ£o atmosfÃ©rica">
                        <div class="weather-detail-icon" style="color:#8b5cf6"><i class="fas fa-tachometer-alt"></i></div>
                        <div><div class="weather-detail-value" id="detailPressure">--</div><div class="weather-detail-label">PressÃ£o</div></div>
                    </div>
                    <div class="weather-detail" data-tooltip="Ãndice de radiaÃ§Ã£o ultravioleta">
                        <div class="weather-detail-icon" style="color:var(--danger)"><i class="fas fa-sun"></i></div>
                        <div><div class="weather-detail-value" id="detailUV">--</div><div class="weather-detail-label">UV</div></div>
                    </div>
                    <div class="weather-detail" data-tooltip="Ponto de orvalho - temperatura de condensaÃ§Ã£o">
                        <div class="weather-detail-icon" style="color:#06b6d4"><i class="fas fa-temperature-low"></i></div>
                        <div><div class="weather-detail-value" id="detailDewPoint">--</div><div class="weather-detail-label">Pto. Orvalho</div></div>
                    </div>
                    <div class="weather-detail" data-tooltip="RadiaÃ§Ã£o solar">
                        <div class="weather-detail-icon" style="color:var(--warning)"><i class="fas fa-solar-panel"></i></div>
                        <div><div class="weather-detail-value" id="detailSolar">--</div><div class="weather-detail-label">Solar</div></div>
                    </div>
                    <div class="weather-detail" data-tooltip="NÃ­vel de bateria do console">
                        <div class="weather-detail-icon" style="color:var(--success)"><i class="fas fa-battery-three-quarters"></i></div>
                        <div><div class="weather-detail-value" id="detailBattery">--%</div><div class="weather-detail-label">Bateria</div></div>
                    </div>
                </div>
                
                <div class="rain-section">
                    <div class="rain-header">
                        <span style="font-size:13px;font-weight:600"><i class="fas fa-cloud-rain" style="color:var(--secondary)"></i> PrecipitaÃ§Ã£o</span>
                        <div class="rain-tabs">
                            <button class="rain-tab active" onclick="setRainPeriod('day')" id="rain-day">Hoje</button>
                            <button class="rain-tab" onclick="setRainPeriod('week')" id="rain-week">Semana</button>
                            <button class="rain-tab" onclick="setRainPeriod('month')" id="rain-month">MÃªs</button>
                            <button class="rain-tab" onclick="setRainPeriod('year')" id="rain-year">Ano</button>
                        </div>
                    </div>
                    <div class="rain-display">
                        <i class="fas fa-cloud-showers-heavy" style="font-size:28px;color:var(--secondary)"></i>
                        <div>
                            <span class="rain-value" id="rainValue">--</span> <span style="font-size:12px;color:var(--text-secondary)" id="rainUnit">mm</span>
                            <div style="font-size:11px;color:var(--text-secondary);margin-top:2px">
                                <i class="fas fa-tint"></i> Taxa: <span id="rainRate">--</span> mm/h
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="wind-section">
                    <div class="wind-rose-container">
                        <div class="wind-rose">
                            <div class="wind-rose-bg"></div>
                            <div class="wind-rose-arrow" id="windArrow"></div>
                            <div class="wind-rose-center"></div>
                            <div class="wind-rose-labels"><span class="n">N</span><span class="s">S</span><span class="e">E</span><span class="w">O</span></div>
                        </div>
                        <div>
                            <div class="wind-speed" id="windSpeed">-- <span id="windUnit" style="font-size:12px">km/h</span></div>
                            <div class="wind-gust" id="windGust">Rajada: --</div>
                            <div class="wind-direction" id="windDirection">Dir: --Â°</div>
                        </div>
                    </div>
                </div>
                
                <div class="weather-updated" id="weatherUpdated"><i class="fas fa-clock"></i> --</div>
            </div>
        </div>
        
        <!-- History Section -->
        <div class="history-section">
            <div class="history-header">
                <h3 style="font-size:16px"><i class="fas fa-chart-area" style="color:var(--primary)"></i> HistÃ³rico</h3>
                <div class="history-filters">
                    <input type="date" class="date-input" id="dateStart">
                    <input type="date" class="date-input" id="dateEnd">
                    <button class="btn btn-primary" onclick="loadHistory()"><i class="fas fa-search"></i></button>
                    <div class="view-toggle" style="display:flex;gap:4px;margin-left:8px">
                        <button class="btn btn-icon btn-secondary active" id="viewChartBtn" onclick="setHistoryView('chart')" title="GrÃ¡fico"><i class="fas fa-chart-line"></i></button>
                        <button class="btn btn-icon btn-secondary" id="viewTableBtn" onclick="setHistoryView('table')" title="Tabela"><i class="fas fa-table"></i></button>
                    </div>
                    <button class="btn btn-secondary" onclick="exportCSV()" title="Exportar CSV"><i class="fas fa-download"></i></button>
                </div>
            </div>
            <div class="chart-container" id="chartContainer"><canvas id="historyChart"></canvas></div>
            <div class="table-container hidden" id="tableContainer" style="max-height:350px;overflow:auto;border-radius:8px;border:1px solid var(--border)">
                <table class="data-table" id="historyTable">
                    <thead id="historyTableHead"></thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
            <div class="summary-grid">
                <div class="summary-card" data-tooltip="Total de precipitaÃ§Ã£o no perÃ­odo selecionado">
                    <div class="summary-card-title"><i class="fas fa-cloud-rain" style="color:var(--info)"></i> Chuva</div>
                    <div class="summary-card-value" id="summaryRain">--</div>
                </div>
                <div class="summary-card" data-tooltip="Temperatura mÃ©dia no perÃ­odo">
                    <div class="summary-card-title"><i class="fas fa-thermometer-half" style="color:var(--warning)"></i> Temp MÃ©dia</div>
                    <div class="summary-card-value" id="summaryTemp">--</div>
                </div>
                <div class="summary-card" data-tooltip="Umidade mÃ©dia no perÃ­odo">
                    <div class="summary-card-title"><i class="fas fa-tint" style="color:var(--secondary)"></i> Umidade</div>
                    <div class="summary-card-value" id="summaryHumidity">--</div>
                </div>
                <div class="summary-card" data-tooltip="Velocidade mÃ©dia do vento">
                    <div class="summary-card-title"><i class="fas fa-wind" style="color:var(--success)"></i> Vento</div>
                    <div class="summary-card-value" id="summaryWind">--</div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- ===== TOOLTIP ELEMENT ===== -->
<div class="tooltip" id="tooltip" style="display:none"></div>

<script>
const SUPABASE_URL='https://byvxingdfvbovozsovip.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5dnhpbmdkZnZib3ZvenNvdmlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NDQ0NTksImV4cCI6MjA4NTAyMDQ1OX0.IyszGbYpPwJr0nwnhDhV0vMMbPDusIx--CIJHfbfArs';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let user=null,profile=null,estacoes=[],estacoesData={},currentEst=null,map=null,markers=[],chart=null,layers={},currentLayer=null;
let unit='metric',rainPeriod='day',mapDisplayMode='temp';

// ============ INIT ============
document.addEventListener('DOMContentLoaded',async()=>{
    try{const{data:{session}}=await sb.auth.getSession();if(session){user=session.user;await loadProfile();showApp()}else showLogin()}catch(e){console.warn('Session check:',e.message);showLogin()}
    sb.auth.onAuthStateChange(async(e,s)=>{if(e==='SIGNED_IN'){user=s.user;await loadProfile();showApp()}else if(e==='SIGNED_OUT')showLogin()});
    document.getElementById('loginForm').onsubmit=login;
    document.getElementById('registerForm').onsubmit=register;
    const d=new Date();
    document.getElementById('dateEnd').value=d.toISOString().split('T')[0];
    document.getElementById('dateStart').value=new Date(d-7*864e5).toISOString().split('T')[0];
    initTooltips();
});

// ============ AUTH ============
function showLogin(){document.getElementById('loginModal').classList.remove('hidden');document.getElementById('appContainer').style.display='none'}
function showApp(){document.getElementById('loginModal').classList.add('hidden');document.getElementById('appContainer').style.display='flex';initApp()}
function toggleRegister(){const l=document.getElementById('loginForm'),r=document.getElementById('registerForm');l.style.display=l.style.display==='none'?'block':'none';r.style.display=r.style.display==='none'?'block':'none'}
async function login(e){e.preventDefault();try{const{error}=await sb.auth.signInWithPassword({email:document.getElementById('loginEmail').value,password:document.getElementById('loginPassword').value});if(error)throw error;toast('Login realizado!','success')}catch(err){toast(err.message,'error')}}
async function register(e){e.preventDefault();try{const{error}=await sb.auth.signUp({email:document.getElementById('registerEmail').value,password:document.getElementById('registerPassword').value,options:{data:{primeiro_nome:document.getElementById('registerName').value}}});if(error)throw error;toast('Conta criada!','success');toggleRegister()}catch(err){toast(err.message,'error')}}
async function logout(){await sb.auth.signOut();showLogin()}
async function loadProfile(){const{data}=await sb.from('perfis').select('*').eq('id',user.id).single();if(data){profile=data;if(data.is_admin)document.getElementById('adminLink').style.display='block'}}

// ============ SIDEBAR MOBILE ============
function openSidebar(){document.getElementById('sidebar').classList.add('open');document.getElementById('sidebarOverlay').classList.add('show')}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('sidebarOverlay').classList.remove('show')}

// ============ CONFIG MODAL ============
function openConfig(){
    if(currentEst){
        document.getElementById('configStationName').textContent=currentEst.nome||'--';
        document.getElementById('configStationIMEI').textContent=currentEst.identificador||'--';
        document.getElementById('configLastSync').textContent=currentEst.ultima_sincronizacao?new Date(currentEst.ultima_sincronizacao).toLocaleString('pt-BR'):'--';
    }
    document.getElementById('configTempUnit').value=unit;
    document.getElementById('configModal').classList.remove('hidden');
}
function closeConfig(){document.getElementById('configModal').classList.add('hidden')}

// ============ INIT APP ============
async function initApp(){initMap();await loadEstacoes();initChart();startAutoRefresh()}

// ============ MAP ============
function initMap(){
    map=L.map('map',{zoomControl:true}).setView([-25.4,-54.6],10);
    layers.street=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    layers.satellite=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
    layers.terrain=L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png');
    layers.satellite.addTo(map);currentLayer='satellite';
}
function setMapLayer(l){if(currentLayer)map.removeLayer(layers[currentLayer]);layers[l].addTo(map);currentLayer=l;document.querySelectorAll('.map-control-btn').forEach(b=>b.classList.remove('active'));document.getElementById('btn-'+l).classList.add('active')}
function setMapDisplay(mode){mapDisplayMode=mode;document.querySelectorAll('.map-display-btn').forEach(b=>b.classList.remove('active'));document.getElementById('map-btn-'+mode).classList.add('active');updateMapMarkers()}

// ============ STATIONS ============
async function loadEstacoes(){
    const{data}=await sb.from('estacoes').select('*').eq('ativo',true);
    estacoes=data||[];
    const sel=document.getElementById('estacaoSelect');
    sel.innerHTML='<option value="">Selecione...</option>';
    for(const e of estacoes){
        sel.innerHTML+=`<option value="${e.id}">${e.nome}</option>`;
    }
    // Carregar dados de TODAS as estaÃ§Ãµes para o mapa
    await reloadAllData();
    if(estacoes.length){sel.value=estacoes[0].id;await loadEstacaoData()}
}

async function loadEstacaoData(){
    const id=document.getElementById('estacaoSelect').value;
    if(!id)return;
    currentEst=estacoes.find(e=>e.id===id);
    const{data}=await sb.from('estacao_dados').select('*').eq('estacao_id',id).order('coletado_em',{ascending:false}).limit(1);
    if(data&&data.length){estacoesData[id]=data[0];displayWeather(data[0])}
    loadHistory();
    if(currentEst&&currentEst.latitude)map.setView([currentEst.latitude,currentEst.longitude],12);
}

// ============ CONVERSIONS ============
function safeNum(v){if(v==null)return null;const n=parseFloat(v);return isNaN(n)?null:n}
function fmt(v,d=1){const n=safeNum(v);return n!==null?n.toFixed(d):'--'}
function c2f(c){return c!==null?(c*9/5)+32:null}
function mm2in(m){return m!==null?m/25.4:null}
function kmh2mph(k){return k!==null?k/1.60934:null}

// ============ UNIT ============
function setUnit(u){
    unit=u;
    document.querySelectorAll('.unit-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('btn-'+u)?.classList.add('active');
    document.getElementById('configTempUnit').value=u;
    const data=currentEst?estacoesData[currentEst.id]:null;
    if(data)displayWeather(data);
    updateMapMarkers();
}

// ============ DISPLAY WEATHER ============
function displayWeather(d){
    if(!d)return;
    const tempC=safeNum(d.temperatura),feelsC=safeNum(d.sensacao_termica),dewC=safeNum(d.ponto_orvalho);
    const temp=unit==='imperial'&&tempC!==null?c2f(tempC):tempC;
    const feels=unit==='imperial'&&feelsC!==null?c2f(feelsC):feelsC;
    const dew=unit==='imperial'&&dewC!==null?c2f(dewC):dewC;
    const uSym=unit==='imperial'?'Â°F':'Â°C';
    
    document.getElementById('currentTemp').textContent=fmt(temp,0);
    document.getElementById('tempUnit').textContent=uSym;
    document.getElementById('weatherFeels').textContent='SensaÃ§Ã£o: '+fmt(feels)+uSym;
    document.getElementById('detailHumidity').textContent=fmt(d.umidade,0)+'%';
    document.getElementById('detailPressure').textContent=fmt(d.pressao_relativa,0)+' hPa';
    document.getElementById('detailUV').textContent=fmt(d.indice_uv,0);
    document.getElementById('detailDewPoint').textContent=fmt(dew)+uSym;
    document.getElementById('detailSolar').textContent=fmt(d.radiacao_solar,0)+' W/mÂ²';
    document.getElementById('detailBattery').textContent=fmt(d.bateria_console,0)+'%';
    
    // Icone de bateria dinamico
    const batVal=safeNum(d.bateria_console);
    const batIcon=document.querySelector('#detailBattery').closest('.weather-detail').querySelector('i');
    if(batIcon&&batVal!==null){
        if(batVal>75)batIcon.className='fas fa-battery-full';
        else if(batVal>50)batIcon.className='fas fa-battery-three-quarters';
        else if(batVal>25)batIcon.className='fas fa-battery-half';
        else if(batVal>10)batIcon.className='fas fa-battery-quarter';
        else batIcon.className='fas fa-battery-empty';
        batIcon.style.color=batVal>20?'var(--success)':'var(--danger)';
    }
    
    updateRainDisplay(d);
    
    const ws=safeNum(d.velocidade_vento),wg=safeNum(d.rajada_vento),wd=safeNum(d.direcao_vento);
    const windS=unit==='imperial'&&ws!==null?kmh2mph(ws):ws;
    const windG=unit==='imperial'&&wg!==null?kmh2mph(wg):wg;
    const wUnit=unit==='imperial'?'mph':'km/h';
    document.getElementById('windSpeed').innerHTML=fmt(windS,0)+' <span style="font-size:12px">'+wUnit+'</span>';
    document.getElementById('windGust').textContent='Rajada: '+fmt(windG)+' '+wUnit;
    document.getElementById('windDirection').textContent='Dir: '+fmt(wd,0)+'Â°';
    if(wd!==null)document.getElementById('windArrow').style.transform='rotate('+wd+'deg)';
    
    if(d.coletado_em){
        const dt=new Date(d.coletado_em);
        document.getElementById('weatherUpdated').innerHTML='<i class="fas fa-clock"></i> '+dt.toLocaleString('pt-BR');
    }
    
    // Update weather icon
    const icon=document.getElementById('weatherIcon');
    if(tempC>30)icon.innerHTML='<i class="fas fa-sun" style="color:var(--warning)"></i>';
    else if(tempC>20)icon.innerHTML='<i class="fas fa-cloud-sun" style="color:var(--warning)"></i>';
    else if(tempC>10)icon.innerHTML='<i class="fas fa-cloud" style="color:var(--text-secondary)"></i>';
    else icon.innerHTML='<i class="fas fa-snowflake" style="color:var(--info)"></i>';
}

function setRainPeriod(p){rainPeriod=p;document.querySelectorAll('.rain-tab').forEach(b=>b.classList.remove('active'));document.getElementById('rain-'+p).classList.add('active');const d=currentEst?estacoesData[currentEst.id]:null;if(d)updateRainDisplay(d)}
function updateRainDisplay(d){
    const vals={day:d.precipitacao_diaria,week:d.precipitacao_semanal,month:d.precipitacao_mensal,year:d.precipitacao_anual};
    let v=safeNum(vals[rainPeriod]);
    let rate=safeNum(d.taxa_precipitacao);
    if(unit==='imperial'){
        if(v!==null)v=mm2in(v);
        if(rate!==null)rate=mm2in(rate);
    }
    document.getElementById('rainValue').textContent=fmt(v,1);
    document.getElementById('rainUnit').textContent=unit==='imperial'?'in':'mm';
    document.getElementById('rainRate').textContent=fmt(rate,1);
}

// ============ MAP MARKERS ============
function getTempColor(t){
    if(t==null)return'#6b7280';
    if(t<=-10)return'#1e40af';if(t<=0)return'#3b82f6';if(t<=10)return'#06b6d4';if(t<=18)return'#10b981';
    if(t<=24)return'#84cc16';if(t<=28)return'#eab308';if(t<=32)return'#f97316';if(t<=36)return'#ef4444';
    return'#991b1b';
}
function getRainColor(r){
    if(r==null||r<=0)return'#6b7280';if(r<=2)return'#93c5fd';if(r<=10)return'#3b82f6';if(r<=20)return'#2563eb';
    if(r<=50)return'#7c3aed';if(r<=100)return'#a855f7';return'#ec4899';
}

async function updateMapMarkers(){
    markers.forEach(m=>map.removeLayer(m));markers=[];
    for(const est of estacoes){
        if(!est.latitude)continue;
        const d=estacoesData[est.id]||{};
        let value,color,label;
        
        if(mapDisplayMode==='temp'){
            const t=safeNum(d.temperatura);
            value=unit==='imperial'&&t!==null?c2f(t):t;
            color=getTempColor(t);
            label=fmt(value,0)+(unit==='imperial'?'Â°F':'Â°C');
        }else{
            const rainKey={rain_day:'precipitacao_diaria',rain_week:'precipitacao_semanal',rain_month:'precipitacao_mensal'}[mapDisplayMode];
            let r=safeNum(d[rainKey]);
            color=getRainColor(r);
            if(unit==='imperial'&&r!==null)r=mm2in(r);
            label=fmt(r,1)+(unit==='imperial'?' in':' mm');
        }
        
        const html=`<div style="position:relative"><div style="background:${color};color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,.3)">${label}</div><div style="position:absolute;bottom:-6px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:6px solid ${color}"></div></div>`;
        const icon=L.divIcon({className:'station-marker',html,iconAnchor:[25,40]});
        const m=L.marker([est.latitude,est.longitude],{icon}).addTo(map);
        
        const popupContent=`<div style="min-width:150px"><strong>${est.nome}</strong><br><hr style="margin:5px 0;border-color:#475569"><b>Temp:</b> ${fmt(d.temperatura)}Â°C<br><b>Umidade:</b> ${fmt(d.umidade,0)}%<br><b>Chuva Hoje:</b> ${fmt(d.precipitacao_diaria)} mm<br><b>Chuva Semana:</b> ${fmt(d.precipitacao_semanal)} mm<br><b>Vento:</b> ${fmt(d.velocidade_vento)} km/h</div>`;
        m.bindPopup(popupContent);
        markers.push(m);
    }
}

// ============ HISTORY ============
function initChart(){
    const ctx=document.getElementById('historyChart').getContext('2d');
    chart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[{label:'Temperatura (Â°C)',data:[],borderColor:'#f59e0b',tension:.3,yAxisID:'y'},{label:'Chuva (mm)',data:[],borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.2)',type:'bar',yAxisID:'y1'}]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{labels:{color:'#94a3b8',font:{size:11}}},tooltip:{callbacks:{label:function(ctx){return ctx.dataset.label+': '+(ctx.parsed.y!==null?ctx.parsed.y.toFixed(1):'--')}}}},scales:{x:{ticks:{color:'#94a3b8',maxRotation:45},grid:{color:'#334155'}},y:{position:'left',ticks:{color:'#f59e0b',callback:v=>v.toFixed(1)+'Â°C'},grid:{color:'#334155'}},y1:{position:'right',ticks:{color:'#3b82f6',callback:v=>v.toFixed(1)+'mm'},grid:{display:false}}}}});
}

async function loadHistory(){
    if(!currentEst)return;
    const start=document.getElementById('dateStart').value,end=document.getElementById('dateEnd').value;
    const{data}=await sb.from('estacao_dados').select('*').eq('estacao_id',currentEst.id).gte('coletado_em',start+'T00:00:00').lte('coletado_em',end+'T23:59:59').order('coletado_em',{ascending:true});
    if(!data||!data.length)return;
    
    // Agrupar por dia
    const dailyData = {};
    data.forEach(d => {
        const day = d.coletado_em.split('T')[0];
        if (!dailyData[day]) dailyData[day] = { temps: [], hums: [], winds: [], monthlyMax: null };
        if (d.temperatura != null) dailyData[day].temps.push(d.temperatura);
        if (d.umidade != null) dailyData[day].hums.push(d.umidade);
        if (d.velocidade_vento != null) dailyData[day].winds.push(d.velocidade_vento);
        // Usar precipitacao_mensal (dados corretos)
        const m = d.precipitacao_mensal;
        if (m != null && (dailyData[day].monthlyMax === null || m > dailyData[day].monthlyMax)) {
            dailyData[day].monthlyMax = m;
        }
    });
    
    const days = Object.keys(dailyData).sort();
    const labels = days.map(d => new Date(d+'T12:00:00').toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'}));
    const temps = days.map(d => dailyData[d].temps.length ? dailyData[d].temps.reduce((a,b)=>a+b,0)/dailyData[d].temps.length : null);
    
    // Chuva: diferenÃ§a do mensal entre dias consecutivos
    // Para o primeiro dia do perÃ­odo, nÃ£o temos como calcular a diferenÃ§a
    // entÃ£o assumimos 0 (ou podemos buscar o dia anterior)
    const rains = days.map((day, i) => {
        const current = dailyData[day].monthlyMax;
        if (current === null) return 0;
        if (i === 0) {
            // Primeiro dia do perÃ­odo - se for dia 1 do mÃªs, usa o valor direto
            const dayOfMonth = parseInt(day.split('-')[2]);
            if (dayOfMonth === 1) return current; // Primeiro dia do mÃªs
            return 0; // NÃ£o temos referÃªncia do dia anterior
        }
        const prevDay = days[i-1];
        const prev = dailyData[prevDay].monthlyMax;
        if (prev === null) return 0;
        if (current < prev) return current; // Resetou o mÃªs
        return Math.max(0, current - prev);
    });
    
    chart.data.labels=labels;
    chart.data.datasets[0].data=temps;
    chart.data.datasets[1].data=rains;
    chart.update();
    
    const validTemps=temps.filter(t=>t!==null);
    const validHum=Object.values(dailyData).flatMap(d=>d.hums);
    const validWind=Object.values(dailyData).flatMap(d=>d.winds);
    
    const totalRain=rains.reduce((a,b)=>a+b,0);
    const avgTemp=validTemps.length?validTemps.reduce((a,b)=>a+b,0)/validTemps.length:null;
    const avgHum=validHum.length?validHum.reduce((a,b)=>a+b,0)/validHum.length:null;
    const avgWind=validWind.length?validWind.reduce((a,b)=>a+b,0)/validWind.length:null;
    
    document.getElementById('summaryRain').textContent=fmt(totalRain)+' mm';
    document.getElementById('summaryTemp').textContent=fmt(avgTemp)+'Â°C';
    document.getElementById('summaryHumidity').textContent=fmt(avgHum,0)+'%';
    document.getElementById('summaryWind').textContent=fmt(avgWind)+' km/h';
    
    // Salvar dados para tabela/export
    window.historyRawData = data;
    window.historyDailyData = { days, dailyData, rains };
    populateTable(data);
}

let historyView = 'chart';
function setHistoryView(view) {
    historyView = view;
    document.getElementById('viewChartBtn').classList.toggle('active', view === 'chart');
    document.getElementById('viewTableBtn').classList.toggle('active', view === 'table');
    document.getElementById('chartContainer').classList.toggle('hidden', view === 'table');
    document.getElementById('tableContainer').classList.toggle('hidden', view === 'chart');
}

function populateTable(data) {
    if (!data || !data.length) return;
    
    const thead = document.getElementById('historyTableHead');
    const tbody = document.getElementById('historyTableBody');
    
    thead.innerHTML = `<tr>
        <th>Data/Hora</th>
        <th>Temp (Â°C)</th>
        <th>SensaÃ§Ã£o</th>
        <th>Pto. Orvalho</th>
        <th>Umidade (%)</th>
        <th>PressÃ£o (hPa)</th>
        <th>Vento (km/h)</th>
        <th>Rajada</th>
        <th>Dir (Â°)</th>
        <th>Chuva Dia</th>
        <th>Chuva MÃªs</th>
        <th>Taxa mm/h</th>
        <th>Solar (W/mÂ²)</th>
        <th>UV</th>
        <th>Bateria (%)</th>
    </tr>`;
    
    tbody.innerHTML = data.map(d => `<tr>
        <td>${new Date(d.coletado_em).toLocaleString('pt-BR')}</td>
        <td>${fmt(d.temperatura)}</td>
        <td>${fmt(d.sensacao_termica)}</td>
        <td>${fmt(d.ponto_orvalho)}</td>
        <td>${fmt(d.umidade, 0)}</td>
        <td>${fmt(d.pressao_relativa, 0)}</td>
        <td>${fmt(d.velocidade_vento)}</td>
        <td>${fmt(d.rajada_vento)}</td>
        <td>${fmt(d.direcao_vento, 0)}</td>
        <td>${fmt(d.precipitacao_diaria)}</td>
        <td>${fmt(d.precipitacao_mensal)}</td>
        <td>${fmt(d.taxa_precipitacao)}</td>
        <td>${fmt(d.radiacao_solar, 0)}</td>
        <td>${fmt(d.indice_uv, 0)}</td>
        <td>${fmt(d.bateria_console, 0)}</td>
    </tr>`).join('');
}

function exportCSV() {
    const data = window.historyRawData;
    if (!data || !data.length) { toast('Nenhum dado para exportar', 'error'); return; }
    
    const headers = ['Data/Hora', 'Temp (Â°C)', 'SensaÃ§Ã£o', 'Pto. Orvalho', 'Umidade (%)', 'PressÃ£o (hPa)', 
        'Vento (km/h)', 'Rajada', 'Dir (Â°)', 'Chuva Dia (mm)', 'Chuva Semana', 'Chuva MÃªs', 'Chuva Ano',
        'Taxa (mm/h)', 'Solar (W/mÂ²)', 'UV', 'Bateria (%)'];
    
    const rows = data.map(d => [
        new Date(d.coletado_em).toLocaleString('pt-BR'),
        d.temperatura, d.sensacao_termica, d.ponto_orvalho, d.umidade, d.pressao_relativa,
        d.velocidade_vento, d.rajada_vento, d.direcao_vento,
        d.precipitacao_diaria, d.precipitacao_semanal, d.precipitacao_mensal, d.precipitacao_anual,
        d.taxa_precipitacao, d.radiacao_solar, d.indice_uv, d.bateria_console
    ].join(';'));
    
    const csv = [headers.join(';'), ...rows].join('\n');
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    const estName = currentEst ? currentEst.nome.replace(/\s+/g, '_') : 'dados';
    link.download = `historico_${estName}_${document.getElementById('dateStart').value}_${document.getElementById('dateEnd').value}.csv`;
    link.click();
    toast('CSV exportado!', 'success');
}

// ============ AUTO REFRESH ============
function startAutoRefresh(){
    setInterval(async()=>{await reloadAllData()},5*60*1000);
    document.getElementById('autoSyncIndicator').classList.remove('off');
}

async function reloadAllData(){
    for(const est of estacoes){
        const{data}=await sb.from('estacao_dados').select('*').eq('estacao_id',est.id).order('coletado_em',{ascending:false}).limit(1);
        if(data&&data.length)estacoesData[est.id]=data[0];
    }
    await updateMapMarkers();
    if(currentEst){
        const d=estacoesData[currentEst.id];
        if(d)displayWeather(d);
    }
}

// ============ SYNC MANUAL ============
async function syncEcowitt(){
    if(!currentEst){toast('Selecione uma estaÃ§Ã£o','error');return}
    const st=document.getElementById('syncStatus');
    st.style.display='flex';st.className='sync-status syncing';st.innerHTML='<i class="fas fa-spinner fa-spin"></i> Atualizando...';
    
    try{
        const{data}=await sb.from('estacao_dados').select('*').eq('estacao_id',currentEst.id).order('coletado_em',{ascending:false}).limit(1);
        if(data&&data.length){
            estacoesData[currentEst.id]=data[0];
            displayWeather(data[0]);
        }
        await updateMapMarkers();
        st.className='sync-status success';st.innerHTML='<i class="fas fa-check-circle"></i> Dados atualizados!';
        toast('Dados atualizados','success');
        setTimeout(()=>st.style.display='none',3000);
    }catch(err){
        st.className='sync-status error';st.innerHTML='<i class="fas fa-exclamation-triangle"></i> '+err.message;
        toast('Erro: '+err.message,'error');
    }
}

// ============ IMPORT HISTORY ============
const ECOWITT_APP_KEY='E298D09B1E24E9B6BF1E1D20A63AA956';
const ECOWITT_API_KEY='0c43a27e-5d7e-4bb4-b531-aecded2bad49';
const f2c=f=>(parseFloat(f)-32)*5/9;
const in2mm=i=>parseFloat(i)*25.4;
const mph2kmh=m=>parseFloat(m)*1.60934;
const inhg2hpa=i=>parseFloat(i)*33.8639;

async function importHistory(){
    if(!currentEst){toast('Selecione uma estaÃ§Ã£o','error');return}

    const monthsVal=parseInt(document.getElementById('historyMonths').value);
    const months=monthsVal===0?60:monthsVal; // 0 = tudo (max 5 anos)
    const st=document.getElementById('syncStatus');
    const btn=document.getElementById('historyBtn');

    st.style.display='flex';st.className='sync-status syncing';
    st.innerHTML='<i class="fas fa-spinner fa-spin"></i> Calculando blocos...';
    btn.disabled=true;
    closeConfig();

    try{
        const mac=currentEst.identificador;
        const endDate=new Date();
        const startDate=new Date();
        startDate.setMonth(startDate.getMonth()-months);

        // Calcular total de blocos para mostrar progresso
        let totalBlocks=0;
        let tmp=new Date(startDate);
        while(tmp<endDate){tmp.setDate(tmp.getDate()+31);totalBlocks++;}

        let totalImported=0;
        let blockNum=0;
        let blocksSkipped=0;
        let current=new Date(startDate);
        const callbacks='outdoor.temperature,outdoor.humidity,outdoor.dew_point,outdoor.feels_like,pressure.relative,wind.wind_speed,wind.wind_gust,wind.wind_direction,rainfall.daily,rainfall.weekly,rainfall.monthly,rainfall.yearly,rainfall.rain_rate,solar_and_uvi.solar,solar_and_uvi.uvi';

        // Importar em blocos de 30 dias (limite da API)
        while(current<endDate){
            blockNum++;
            const blockEnd=new Date(current);
            blockEnd.setDate(blockEnd.getDate()+30);
            if(blockEnd>endDate)blockEnd.setTime(endDate.getTime());

            const sd=current.toISOString().split('T')[0]+' 00:00:00';
            const ed=blockEnd.toISOString().split('T')[0]+' 23:59:59';

            st.innerHTML=`<i class="fas fa-spinner fa-spin"></i> Bloco ${blockNum}/${totalBlocks} â€” ${sd.split(' ')[0]} a ${ed.split(' ')[0]} (${totalImported} registros)`;

            const url=`https://api.ecowitt.net/api/v3/device/history?application_key=${ECOWITT_APP_KEY}&api_key=${ECOWITT_API_KEY}&mac=${encodeURIComponent(mac)}&start_date=${encodeURIComponent(sd)}&end_date=${encodeURIComponent(ed)}&call_back=${callbacks}&cycle_type=30min`;

            try{
                let json=null;
                for(let attempt=0;attempt<5;attempt++){
                    const resp=await fetch(url);
                    json=await resp.json();
                    if(json.code===0)break;
                    if(json.msg&&json.msg.includes('upper limit')){
                        const wait=10*(attempt+1);
                        st.innerHTML=`<i class="fas fa-spinner fa-spin"></i> Bloco ${blockNum}/${totalBlocks} â€” Limite da API, aguardando ${wait}s...`;
                        await new Promise(r=>setTimeout(r,wait*1000));
                        json=null;
                    }else{
                        console.warn('API error for block:',json.msg);
                        json=null;break;
                    }
                }

                if(!json||json.code!==0){
                    blocksSkipped++;
                    current.setDate(current.getDate()+31);
                    continue;
                }

                const d=json.data;
                const tempList=d.outdoor?.temperature?.list||{};
                const timestamps=Object.keys(tempList).sort();

                if(timestamps.length){
                    const registros=[];
                    for(const ts of timestamps){
                        const dt=new Date(parseInt(ts)*1000).toISOString();
                        const reg={
                            estacao_id:currentEst.id,
                            coletado_em:dt,
                            temperatura:d.outdoor?.temperature?.list?.[ts]?f2c(d.outdoor.temperature.list[ts]):null,
                            sensacao_termica:d.outdoor?.feels_like?.list?.[ts]?f2c(d.outdoor.feels_like.list[ts]):null,
                            ponto_orvalho:d.outdoor?.dew_point?.list?.[ts]?f2c(d.outdoor.dew_point.list[ts]):null,
                            umidade:d.outdoor?.humidity?.list?.[ts]?parseFloat(d.outdoor.humidity.list[ts]):null,
                            pressao_relativa:d.pressure?.relative?.list?.[ts]?inhg2hpa(d.pressure.relative.list[ts]):null,
                            velocidade_vento:d.wind?.wind_speed?.list?.[ts]?mph2kmh(d.wind.wind_speed.list[ts]):null,
                            rajada_vento:d.wind?.wind_gust?.list?.[ts]?mph2kmh(d.wind.wind_gust.list[ts]):null,
                            direcao_vento:d.wind?.wind_direction?.list?.[ts]?parseFloat(d.wind.wind_direction.list[ts]):null,
                            precipitacao_diaria:d.rainfall?.daily?.list?.[ts]?in2mm(d.rainfall.daily.list[ts]):null,
                            precipitacao_semanal:d.rainfall?.weekly?.list?.[ts]?in2mm(d.rainfall.weekly.list[ts]):null,
                            precipitacao_mensal:d.rainfall?.monthly?.list?.[ts]?in2mm(d.rainfall.monthly.list[ts]):null,
                            precipitacao_anual:d.rainfall?.yearly?.list?.[ts]?in2mm(d.rainfall.yearly.list[ts]):null,
                            taxa_precipitacao:d.rainfall?.rain_rate?.list?.[ts]?in2mm(d.rainfall.rain_rate.list[ts]):null,
                            radiacao_solar:d.solar_and_uvi?.solar?.list?.[ts]?parseFloat(d.solar_and_uvi.solar.list[ts]):null,
                            indice_uv:d.solar_and_uvi?.uvi?.list?.[ts]?parseFloat(d.solar_and_uvi.uvi.list[ts]):null,
                        };
                        registros.push(reg);
                    }

                    // Inserir em lotes de 500
                    for(let i=0;i<registros.length;i+=500){
                        const batch=registros.slice(i,i+500);
                        await sb.from('estacao_dados').upsert(batch,{onConflict:'estacao_id,coletado_em',ignoreDuplicates:true});
                    }
                    totalImported+=registros.length;
                }
            }catch(blockErr){
                console.warn('Erro no bloco '+blockNum+':',blockErr.message);
                blocksSkipped++;
            }

            current.setDate(current.getDate()+31);
            await new Promise(r=>setTimeout(r,3000)); // Rate limit: 3s entre blocos
        }

        const msg=totalImported+' registros importados!'+(blocksSkipped?' ('+blocksSkipped+' blocos ignorados)':'');
        st.className='sync-status success';
        st.innerHTML='<i class="fas fa-check-circle"></i> '+msg;
        toast('HistÃ³rico: '+msg,'success');
        loadHistory();
        setTimeout(()=>st.style.display='none',8000);
    }catch(err){
        console.error(err);
        st.className='sync-status error';st.innerHTML='<i class="fas fa-exclamation-triangle"></i> '+err.message;
        toast('Erro: '+err.message,'error');
    }
    btn.disabled=false;
}

// ============ TOOLTIPS (TOUCH SUPPORT) ============
function initTooltips(){
    const tooltip=document.getElementById('tooltip');
    const elements=document.querySelectorAll('[data-tooltip]');
    
    elements.forEach(el=>{
        // Mouse events
        el.addEventListener('mouseenter',e=>showTooltip(e,el.dataset.tooltip));
        el.addEventListener('mouseleave',()=>hideTooltip());
        el.addEventListener('mousemove',e=>moveTooltip(e));
        
        // Touch events
        el.addEventListener('touchstart',e=>{
            e.preventDefault();
            showTooltip(e.touches[0],el.dataset.tooltip);
        });
        el.addEventListener('touchend',()=>setTimeout(hideTooltip,1500));
    });
    
    function showTooltip(e,text){
        tooltip.innerHTML=text;
        tooltip.style.display='block';
        moveTooltip(e);
    }
    
    function moveTooltip(e){
        const x=e.clientX||e.pageX;
        const y=e.clientY||e.pageY;
        tooltip.style.left=Math.min(x+10,window.innerWidth-220)+'px';
        tooltip.style.top=Math.min(y+10,window.innerHeight-60)+'px';
    }
    
    function hideTooltip(){tooltip.style.display='none'}
}

// ============ TOAST ============
function toast(msg,type='info'){
    const t=document.createElement('div');
    t.className='toast '+type;
    t.textContent=msg;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(),4000);
}
</script>
</body>
</html>

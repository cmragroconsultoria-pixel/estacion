<!DOCTYPE html>
<html lang="es-PY">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agro Consultoria - Pron√≥stico 10 D√≠as</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{--primary:#10b981;--primary-dark:#059669;--secondary:#3b82f6;--bg-dark:#1e293b;--bg-darker:#0f172a;--bg-card:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--border:#475569;--success:#22c55e;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6}
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;background:var(--bg-darker);color:var(--text-primary);min-height:100vh}
        .app-container{display:flex;min-height:100vh}.sidebar{width:240px;background:var(--bg-dark);border-right:1px solid var(--border);position:fixed;height:100vh;z-index:100}
        .sidebar-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}.sidebar-logo{width:36px;height:36px;background:linear-gradient(135deg,var(--primary),var(--secondary));border-radius:8px;display:flex;align-items:center;justify-content:center}.sidebar-brand{font-size:18px;font-weight:700;color:var(--primary)}
        .sidebar-nav{padding:15px}.nav-item{display:flex;align-items:center;gap:12px;padding:12px 15px;color:var(--text-secondary);text-decoration:none;border-radius:8px;margin-bottom:4px}.nav-item:hover{background:var(--bg-card);color:var(--text-primary)}.nav-item.active{background:var(--primary);color:white}
        .main-content{flex:1;margin-left:240px;padding:20px}
        
        /* Header Location */
        .location-header{background:var(--bg-card);border-radius:12px;padding:20px;margin-bottom:20px}
        .location-top{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px}
        .location-info h1{font-size:24px;font-weight:600;margin-bottom:4px}
        .location-info p{color:var(--text-secondary);font-size:13px}
        .location-current{display:flex;align-items:center;gap:20px}
        .current-temp{font-size:48px;font-weight:300}
        .current-icon{font-size:48px}
        .station-badge{background:var(--primary);color:white;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600}
        
        /* Controls */
        .controls{display:flex;gap:15px;align-items:center;flex-wrap:wrap;margin-bottom:20px}
        .search-box{display:flex;gap:8px}.search-input{padding:10px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);width:260px;font-size:13px}
        .btn{padding:10px 16px;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;display:inline-flex;align-items:center;gap:6px}.btn-primary{background:var(--primary);color:white}.btn-secondary{background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border)}
        .unit-toggle{display:flex;background:var(--bg-card);border-radius:6px;overflow:hidden}.unit-btn{padding:8px 14px;border:none;background:transparent;color:var(--text-secondary);cursor:pointer;font-size:12px}.unit-btn.active{background:var(--primary);color:white}
        
        /* Tabs */
        .tabs{display:flex;gap:4px;margin-bottom:20px;border-bottom:1px solid var(--border);padding-bottom:12px}
        .tab{padding:10px 20px;background:transparent;border:none;color:var(--text-secondary);cursor:pointer;font-size:14px;font-weight:500;border-radius:8px 8px 0 0}.tab:hover{color:var(--text-primary)}.tab.active{background:var(--primary);color:white}
        
        /* 10-Day Forecast Cards - Weather Underground Style */
        .forecast-row{display:flex;gap:8px;overflow-x:auto;padding-bottom:15px;margin-bottom:20px}
        .day-card{min-width:110px;background:var(--bg-card);border-radius:12px;padding:15px 12px;text-align:center;cursor:pointer;transition:all .2s;border:2px solid transparent;flex-shrink:0}
        .day-card:hover{border-color:var(--primary);transform:translateY(-2px)}
        .day-card.active{border-color:var(--primary);background:linear-gradient(135deg,var(--bg-card),var(--bg-dark))}
        .day-card .day-name{font-size:13px;font-weight:600;margin-bottom:2px}
        .day-card .day-date{font-size:11px;color:var(--text-secondary);margin-bottom:10px}
        .day-card .day-icon{font-size:32px;margin-bottom:8px}
        .day-card .temps{display:flex;justify-content:center;gap:8px;font-size:16px;margin-bottom:6px}
        .day-card .temp-high{color:#ef4444;font-weight:600}
        .day-card .temp-low{color:#3b82f6}
        .day-card .condition{font-size:10px;color:var(--text-secondary);margin-bottom:6px;height:24px;overflow:hidden}
        .day-card .rain-prob{font-size:11px;color:var(--secondary)}.day-card .rain-prob i{margin-right:3px}
        .day-card .precip{font-size:10px;color:var(--info);margin-top:4px}
        
        /* Charts Section - Weather Underground Style */
        .charts-section{background:var(--bg-card);border-radius:12px;padding:20px;margin-bottom:20px}
        .chart-title{font-size:16px;font-weight:600;margin-bottom:15px;display:flex;align-items:center;gap:10px}
        .chart-title i{color:var(--primary)}
        .chart-container{height:200px;margin-bottom:20px}
        .chart-legend{display:flex;flex-wrap:wrap;gap:15px;font-size:11px;justify-content:center;margin-top:10px}
        .legend-item{display:flex;align-items:center;gap:5px}
        .legend-color{width:12px;height:3px;border-radius:2px}
        
        /* Hourly Detail */
        .hourly-section{background:var(--bg-card);border-radius:12px;padding:20px;margin-bottom:20px;display:none}
        .hourly-section.show{display:block}
        .hourly-title{font-size:16px;font-weight:600;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center}
        .hourly-scroll{display:flex;gap:10px;overflow-x:auto;padding-bottom:10px}
        .hour-card{min-width:70px;background:var(--bg-dark);border-radius:10px;padding:12px 8px;text-align:center;flex-shrink:0}
        .hour-card .time{font-size:11px;font-weight:500;margin-bottom:6px}
        .hour-card .icon{font-size:22px;margin-bottom:4px}
        .hour-card .temp{font-size:16px;font-weight:600}
        .hour-card .rain{font-size:9px;color:var(--secondary);margin-top:4px}
        .hour-card .wind{font-size:9px;color:var(--text-secondary);margin-top:2px}
        
        /* Radar Map */
        .radar-section{background:var(--bg-card);border-radius:12px;padding:20px;margin-bottom:20px}
        .radar-title{font-size:16px;font-weight:600;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center}
        .radar-controls{display:flex;gap:8px;align-items:center}
        .radar-btn{padding:6px 12px;background:var(--bg-dark);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);cursor:pointer;font-size:11px}.radar-btn:hover{border-color:var(--primary)}.radar-btn.active{background:var(--primary);border-color:var(--primary)}
        #radarMap{height:400px;border-radius:8px;overflow:hidden}
        .radar-time{text-align:center;margin-top:10px;font-size:12px;color:var(--text-secondary)}
        .radar-legend{display:flex;justify-content:center;gap:15px;margin-top:15px;font-size:10px}
        .radar-legend-item{display:flex;align-items:center;gap:4px}
        .radar-legend-color{width:20px;height:10px;border-radius:2px}
        
        /* Stats Grid */
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
        .stat-card{background:var(--bg-card);border-radius:12px;padding:18px}
        .stat-card-title{font-size:12px;color:var(--text-secondary);margin-bottom:8px;display:flex;align-items:center;gap:6px}
        .stat-card-value{font-size:28px;font-weight:600}
        .stat-card-sub{font-size:11px;color:var(--text-secondary);margin-top:4px}
        
        .toast{position:fixed;top:20px;right:20px;padding:12px 20px;background:var(--bg-card);border-radius:8px;border-left:4px solid var(--primary);z-index:2000;font-size:13px}.toast.error{border-color:var(--danger)}
        .loading{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--text-secondary)}
        
        @media(max-width:768px){.sidebar{display:none}.main-content{margin-left:0}.day-card{min-width:90px}}
    </style>
</head>
<body>
<div class="app-container">
<aside class="sidebar"><div class="sidebar-header"><div class="sidebar-logo"><i class="fas fa-cloud-sun-rain" style="color:white;font-size:16px"></i></div><span class="sidebar-brand">Agro Consultoria</span></div><nav class="sidebar-nav"><a href="index_es.html" class="nav-item"><i class="fas fa-chart-line"></i> Dashboard</a><a href="previsao.html" class="nav-item active"><i class="fas fa-cloud-sun"></i> Previs√£o</a><a href="relatorios_es.html" class="nav-item"><i class="fas fa-file-alt"></i> Relat√≥rios</a><a href="admin_es.html" class="nav-item" id="adminLink" style="display:none"><i class="fas fa-cog"></i> Admin</a><a href="#" class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</a><div style="margin-top:auto;padding-top:15px;border-top:1px solid var(--border)"><a href="previsao.html" class="nav-item" style="justify-content:center"><span style="font-size:16px">üáßüá∑</span> Portugu√™s</a></div></nav></aside>
<main class="main-content">

<div class="location-header">
    <div class="location-top">
        <div class="location-info">
            <h1 id="locationName">Cargando...</h1>
            <p id="locationCoords">--</p>
        </div>
        <div class="location-current">
            <div class="current-icon" id="currentIcon"><i class="fas fa-sun" style="color:#fcd34d"></i></div>
            <div class="current-temp"><span id="currentTemp">--</span>¬∞<span id="unitLabel">C</span></div>
            <div><span class="station-badge" id="stationBadge">ESTA√á√ÉO</span></div>
        </div>
    </div>
</div>

<div class="controls">
    <div class="search-box">
        <input type="text" class="search-input" id="searchCity" placeholder="Buscar ciudad o usar estaci√≥n...">
        <button class="btn btn-primary" onclick="searchWeather()"><i class="fas fa-search"></i></button>
    </div>
    <button class="btn btn-secondary" onclick="useStationLocation()"><i class="fas fa-broadcast-tower"></i> Usar Esta√ß√£o</button>
    <div class="unit-toggle">
        <button class="unit-btn active" onclick="setUnit('C')" id="btn-C">¬∞C</button>
        <button class="unit-btn" onclick="setUnit('F')" id="btn-F">¬∞F</button>
    </div>
</div>

<div class="tabs">
    <button class="tab active" onclick="showTab('forecast')">10 D√çAS</button>
    <button class="tab" onclick="showTab('hourly')">HORARIO</button>
    <button class="tab" onclick="showTab('radar')">RADAR</button>
</div>

<!-- 10-Day Forecast -->
<div id="tab-forecast">
    <div class="forecast-row" id="forecastRow"></div>
    
    <div class="charts-section">
        <div class="chart-title"><i class="fas fa-chart-line"></i> Temperatura & Sensaci√≥n T√©rmica</div>
        <div class="chart-container"><canvas id="tempChart"></canvas></div>
        <div class="chart-legend">
            <div class="legend-item"><div class="legend-color" style="background:#ef4444"></div> M√°xima</div>
            <div class="legend-item"><div class="legend-color" style="background:#f97316"></div> Sensa√ß√£o</div>
            <div class="legend-item"><div class="legend-color" style="background:#3b82f6"></div> M√≠nima</div>
            <div class="legend-item"><div class="legend-color" style="background:#22c55e"></div> Punto de Roc√≠o</div>
        </div>
    </div>
    
    <div class="charts-section">
        <div class="chart-title"><i class="fas fa-cloud-rain"></i> Precipitaci√≥n, Nubosidad & Humedad</div>
        <div class="chart-container"><canvas id="rainChart"></canvas></div>
        <div class="chart-legend">
            <div class="legend-item"><div class="legend-color" style="background:rgba(59,130,246,.7)"></div> Prob. Lluvia (%)</div>
            <div class="legend-item"><div class="legend-color" style="background:rgba(148,163,184,.5)"></div> Nubosidad (%)</div>
            <div class="legend-item"><div class="legend-color" style="background:#22c55e"></div> Umidade (%)</div>
            <div class="legend-item"><div class="legend-color" style="background:#0ea5e9"></div> Precip. (mm)</div>
        </div>
    </div>
    
    <div class="charts-section">
        <div class="chart-title"><i class="fas fa-wind"></i> Viento & Presi√≥n</div>
        <div class="chart-container"><canvas id="windChart"></canvas></div>
        <div class="chart-legend">
            <div class="legend-item"><div class="legend-color" style="background:#3b82f6"></div> Vento (km/h)</div>
            <div class="legend-item"><div class="legend-color" style="background:#1e293b"></div> Press√£o (hPa)</div>
        </div>
    </div>
    
    <div class="hourly-section" id="hourlyDetail">
        <div class="hourly-title">
            <span><i class="fas fa-clock" style="color:var(--primary);margin-right:8px"></i> Pron√≥stico Horario - <span id="selectedDayName">Hoy</span></span>
            <button class="btn btn-secondary" onclick="closeHourly()" style="padding:6px 12px;font-size:11px"><i class="fas fa-times"></i></button>
        </div>
        <div class="hourly-scroll" id="hourlyScroll"></div>
    </div>
</div>

<!-- Hourly Tab -->
<div id="tab-hourly" style="display:none">
    <div class="charts-section">
        <div class="chart-title"><i class="fas fa-clock"></i> Pr√≥ximas 48 Horas</div>
        <div class="hourly-scroll" id="hourly48"></div>
    </div>
</div>

<!-- Radar Tab -->
<div id="tab-radar" style="display:none">
    <div class="radar-section">
        <div class="radar-title">
            <span><i class="fas fa-satellite-dish" style="color:var(--primary);margin-right:8px"></i> Radar Meteorol√≥gico</span>
            <div class="radar-controls">
                <button class="radar-btn" onclick="radarPrev()"><i class="fas fa-step-backward"></i></button>
                <button class="radar-btn" onclick="toggleRadarPlay()" id="radarPlayBtn"><i class="fas fa-play"></i></button>
                <button class="radar-btn" onclick="radarNext()"><i class="fas fa-step-forward"></i></button>
                <button class="radar-btn active" id="btn-radar" onclick="setRadarLayer('radar')">Chuva</button>
                <button class="radar-btn" id="btn-satellite" onclick="setRadarLayer('satellite')">Sat√©lite</button>
            </div>
        </div>
        <div id="radarMap"></div>
        <div class="radar-time" id="radarTime">--</div>
        <div class="radar-legend">
            <div class="radar-legend-item"><div class="radar-legend-color" style="background:#00ff00"></div> Leve</div>
            <div class="radar-legend-item"><div class="radar-legend-color" style="background:#ffff00"></div> Moderada</div>
            <div class="radar-legend-item"><div class="radar-legend-color" style="background:#ff8000"></div> Forte</div>
            <div class="radar-legend-item"><div class="radar-legend-color" style="background:#ff0000"></div> Muy Fuerte</div>
        </div>
    </div>
</div>

<div class="loading" id="loading" style="display:none"><i class="fas fa-spinner fa-spin" style="font-size:24px;margin-right:10px"></i> Cargando pron√≥stico...</div>
</main>
</div>

<script>
const SUPABASE_URL='https://byvxingdfvbovozsovip.supabase.co',SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5dnhpbmdkZnZib3ZvenNvdmlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NDQ0NTksImV4cCI6MjA4NTAyMDQ1OX0.IyszGbYpPwJr0nwnhDhV0vMMbPDusIx--CIJHfbfArs';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let unit='C',estacoes=[],currentLat=null,currentLon=null,forecastData=null,hourlyData=null,selectedDay=0;
let tempChart=null,rainChart=null,windChart=null;
let radarMap=null,radarLayer=null,radarFrames=[],currentFrame=0,radarPlaying=false,radarInterval=null,radarLayerType='radar';

document.addEventListener('DOMContentLoaded',async()=>{
    try{var{data:{session}}=await sb.auth.getSession()}catch(e){window.location.href='index.html';return}
    if(!session){window.location.href='index.html';return}
    await loadEstacoes();
    initCharts();
});

async function loadEstacoes(){
    const{data}=await sb.from('estacoes').select('*').eq('ativo',true);
    estacoes=data||[];
    if(estacoes.length&&estacoes[0].latitude&&estacoes[0].longitude){
        currentLat=estacoes[0].latitude;
        currentLon=estacoes[0].longitude;
        document.getElementById('stationBadge').textContent=estacoes[0].nome||estacoes[0].identificador;
        loadForecast(currentLat,currentLon,estacoes[0].nome||estacoes[0].cidade||'Esta√ß√£o');
    }
}

function useStationLocation(){
    if(estacoes.length&&estacoes[0].latitude){
        const e=estacoes[0];
        currentLat=e.latitude;currentLon=e.longitude;
        document.getElementById('stationBadge').textContent=e.nome||e.identificador;
        loadForecast(e.latitude,e.longitude,e.nome||e.cidade||'Esta√ß√£o');
    }else{toast('Ninguna estaci√≥n','error')}
}

async function searchWeather(){
    const q=document.getElementById('searchCity').value;
    if(!q)return;
    try{
        const res=await fetch('https://geocoding-api.open-meteo.com/v1/search?name='+encodeURIComponent(q)+'&count=1&language=pt');
        const data=await res.json();
        if(data.results&&data.results.length){
            const r=data.results[0];
            currentLat=r.latitude;currentLon=r.longitude;
            document.getElementById('stationBadge').textContent='BUSCA';
            loadForecast(r.latitude,r.longitude,r.name+(r.admin1?', '+r.admin1:''));
        }else{toast('Ciudad no encontrada','error')}
    }catch(err){toast('Error','error')}
}

async function loadForecast(lat,lon,name){
    document.getElementById('loading').style.display='flex';
    try{
        // Open-Meteo API - 16 days forecast
        const params=new URLSearchParams({
            latitude:lat,longitude:lon,
            current:'temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,weather_code,cloud_cover,pressure_msl,wind_speed_10m,wind_direction_10m,uv_index',
            hourly:'temperature_2m,relative_humidity_2m,dew_point_2m,apparent_temperature,precipitation_probability,precipitation,weather_code,cloud_cover,wind_speed_10m,wind_direction_10m,pressure_msl',
            daily:'weather_code,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,precipitation_sum,precipitation_probability_max,sunrise,sunset,uv_index_max,wind_speed_10m_max,wind_direction_10m_dominant',
            timezone:'America/Sao_Paulo',
            forecast_days:10
        });
        const res=await fetch('https://api.open-meteo.com/v1/forecast?'+params);
        const data=await res.json();
        
        forecastData=data.daily;
        hourlyData=data.hourly;
        
        document.getElementById('locationName').textContent=name;
        document.getElementById('locationCoords').textContent=`Lat: ${lat.toFixed(4)} | Lon: ${lon.toFixed(4)} | Elev: ${data.elevation||'--'}m`;
        
        displayCurrent(data.current);
        displayForecast(data.daily);
        displayCharts(data.daily,data.hourly);
        displayHourly48(data.hourly);
        
    }catch(err){console.error(err);toast('Erro ao carregar','error')}
    document.getElementById('loading').style.display='none';
}

function displayCurrent(c){
    const temp=unit==='F'?c2f(c.temperature_2m):c.temperature_2m;
    const cond=getCondition(c.weather_code);
    document.getElementById('currentTemp').textContent=Math.round(temp);
    document.getElementById('unitLabel').textContent=unit;
    document.getElementById('currentIcon').innerHTML=`<i class="fas ${cond.icon}" style="color:${cond.color}"></i>`;
}

function displayForecast(d){
    const days=['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
    let html='';
    for(let i=0;i<d.time.length;i++){
        const date=new Date(d.time[i]+'T12:00:00');
        const tmax=unit==='F'?c2f(d.temperature_2m_max[i]):d.temperature_2m_max[i];
        const tmin=unit==='F'?c2f(d.temperature_2m_min[i]):d.temperature_2m_min[i];
        const cond=getCondition(d.weather_code[i]);
        const prob=d.precipitation_probability_max[i]||0;
        const precip=d.precipitation_sum[i]||0;
        
        html+=`<div class="day-card ${i===selectedDay?'active':''}" onclick="selectDay(${i})">
            <div class="day-name">${i===0?'Hoje':i===1?'Amanh√£':days[date.getDay()]}</div>
            <div class="day-date">${date.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'})}</div>
            <div class="day-icon"><i class="fas ${cond.icon}" style="color:${cond.color}"></i></div>
            <div class="temps"><span class="temp-high">${Math.round(tmax)}¬∞</span><span class="temp-low">${Math.round(tmin)}¬∞</span></div>
            <div class="condition">${cond.text}</div>
            ${prob>0?`<div class="rain-prob"><i class="fas fa-tint"></i>${prob}%</div>`:''}
            ${precip>0?`<div class="precip">${precip.toFixed(1)} mm</div>`:''}
        </div>`;
    }
    document.getElementById('forecastRow').innerHTML=html;
}

function selectDay(idx){
    selectedDay=idx;
    displayForecast(forecastData);
    showHourlyForDay(idx);
}

function showHourlyForDay(dayIdx){
    const date=forecastData.time[dayIdx];
    const dayName=dayIdx===0?'Hoje':dayIdx===1?'Amanh√£':new Date(date+'T12:00:00').toLocaleDateString('pt-BR',{weekday:'long'});
    document.getElementById('selectedDayName').textContent=dayName;
    
    let html='';
    for(let i=0;i<hourlyData.time.length;i++){
        if(hourlyData.time[i].startsWith(date)){
            const time=new Date(hourlyData.time[i]);
            const temp=unit==='F'?c2f(hourlyData.temperature_2m[i]):hourlyData.temperature_2m[i];
            const cond=getCondition(hourlyData.weather_code[i]);
            const prob=hourlyData.precipitation_probability[i]||0;
            const wind=hourlyData.wind_speed_10m[i];
            
            html+=`<div class="hour-card">
                <div class="time">${time.getHours().toString().padStart(2,'0')}:00</div>
                <div class="icon"><i class="fas ${cond.icon}" style="color:${cond.color}"></i></div>
                <div class="temp">${Math.round(temp)}¬∞</div>
                ${prob>0?`<div class="rain"><i class="fas fa-tint"></i> ${prob}%</div>`:''}
                <div class="wind"><i class="fas fa-wind"></i> ${Math.round(wind)}</div>
            </div>`;
        }
    }
    document.getElementById('hourlyScroll').innerHTML=html;
    document.getElementById('hourlyDetail').classList.add('show');
}

function closeHourly(){document.getElementById('hourlyDetail').classList.remove('show')}

function displayHourly48(h){
    let html='';
    for(let i=0;i<48&&i<h.time.length;i++){
        const time=new Date(h.time[i]);
        const temp=unit==='F'?c2f(h.temperature_2m[i]):h.temperature_2m[i];
        const cond=getCondition(h.weather_code[i]);
        const prob=h.precipitation_probability[i]||0;
        
        html+=`<div class="hour-card">
            <div class="time">${time.getHours().toString().padStart(2,'0')}:00</div>
            <div class="icon"><i class="fas ${cond.icon}" style="color:${cond.color}"></i></div>
            <div class="temp">${Math.round(temp)}¬∞</div>
            ${prob>0?`<div class="rain"><i class="fas fa-tint"></i> ${prob}%</div>`:''}
        </div>`;
    }
    document.getElementById('hourly48').innerHTML=html;
}

function initCharts(){
    const opts={responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#94a3b8'},grid:{color:'rgba(255,255,255,.05)'}},y:{ticks:{color:'#94a3b8'},grid:{color:'rgba(255,255,255,.05)'}}}};
    tempChart=new Chart(document.getElementById('tempChart'),{type:'line',data:{labels:[],datasets:[]},options:{...opts,scales:{...opts.scales,y1:{position:'right',ticks:{color:'#94a3b8'},grid:{drawOnChartArea:false}}}}});
    rainChart=new Chart(document.getElementById('rainChart'),{type:'line',data:{labels:[],datasets:[]},options:{...opts,scales:{...opts.scales,y:{max:100},y1:{position:'right',ticks:{color:'#94a3b8'},grid:{drawOnChartArea:false}}}}});
    windChart=new Chart(document.getElementById('windChart'),{type:'line',data:{labels:[],datasets:[]},options:{...opts,scales:{...opts.scales,y1:{position:'right',ticks:{color:'#94a3b8'},grid:{drawOnChartArea:false}}}}});
}

function displayCharts(d,h){
    const labels=d.time.map(t=>new Date(t+'T12:00:00').toLocaleDateString('pt-BR',{weekday:'short'}));
    
    // Temperature chart
    let tmax=d.temperature_2m_max,tmin=d.temperature_2m_min,feels=d.apparent_temperature_max;
    // Dew point from hourly (average per day)
    let dewPoints=d.time.map(day=>{
        let vals=[];
        h.time.forEach((t,i)=>{if(t.startsWith(day))vals.push(h.dew_point_2m[i])});
        return vals.length?vals.reduce((a,b)=>a+b)/vals.length:null;
    });
    
    if(unit==='F'){tmax=tmax.map(c2f);tmin=tmin.map(c2f);feels=feels.map(c2f);dewPoints=dewPoints.map(v=>v?c2f(v):null)}
    
    tempChart.data.labels=labels;
    tempChart.data.datasets=[
        {label:'M√°xima',data:tmax,borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,.1)',fill:true,tension:.4},
        {label:'Sensaci√≥n',data:feels,borderColor:'#f97316',borderDash:[5,5],tension:.4},
        {label:'M√≠nima',data:tmin,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.1)',fill:true,tension:.4},
        {label:'Roc√≠o',data:dewPoints,borderColor:'#22c55e',tension:.4}
    ];
    tempChart.update();
    
    // Rain/Humidity chart
    // Get average humidity per day from hourly
    let humidityAvg=d.time.map(day=>{
        let vals=[];
        h.time.forEach((t,i)=>{if(t.startsWith(day))vals.push(h.relative_humidity_2m[i])});
        return vals.length?vals.reduce((a,b)=>a+b)/vals.length:null;
    });
    let cloudAvg=d.time.map(day=>{
        let vals=[];
        h.time.forEach((t,i)=>{if(t.startsWith(day))vals.push(h.cloud_cover[i])});
        return vals.length?vals.reduce((a,b)=>a+b)/vals.length:null;
    });
    
    rainChart.data.labels=labels;
    rainChart.data.datasets=[
        {label:'Prob. Chuva',data:d.precipitation_probability_max,borderColor:'rgba(59,130,246,.7)',backgroundColor:'rgba(59,130,246,.2)',fill:true,tension:.4,yAxisID:'y'},
        {label:'Nebulosidade',data:cloudAvg,borderColor:'rgba(148,163,184,.5)',backgroundColor:'rgba(148,163,184,.1)',fill:true,tension:.4,yAxisID:'y'},
        {label:'Umidade',data:humidityAvg,borderColor:'#22c55e',tension:.4,yAxisID:'y'},
        {label:'Precipita√ß√£o',data:d.precipitation_sum,type:'bar',backgroundColor:'rgba(14,165,233,.5)',yAxisID:'y1'}
    ];
    rainChart.update();
    
    // Wind chart
    let pressureAvg=d.time.map(day=>{
        let vals=[];
        h.time.forEach((t,i)=>{if(t.startsWith(day))vals.push(h.pressure_msl[i])});
        return vals.length?vals.reduce((a,b)=>a+b)/vals.length:null;
    });
    
    windChart.data.labels=labels;
    windChart.data.datasets=[
        {label:'Viento',data:d.wind_speed_10m_max,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.1)',fill:true,tension:.4,yAxisID:'y'},
        {label:'Presi√≥n',data:pressureAvg,borderColor:'#1e293b',backgroundColor:'rgba(30,41,59,.3)',fill:true,tension:.4,yAxisID:'y1'}
    ];
    windChart.update();
}

function showTab(tab){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    event.target.classList.add('active');
    ['forecast','hourly','radar'].forEach(t=>document.getElementById('tab-'+t).style.display=t===tab?'block':'none');
    if(tab==='radar'&&!radarMap)initRadar();
}

// RADAR MAP - RainViewer API
async function initRadar(){
    radarMap=L.map('radarMap').setView([currentLat||-25.5,currentLon||-54.6],7);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'CartoDB'}).addTo(radarMap);
    await loadRadarFrames();
}

async function loadRadarFrames(){
    try{
        const res=await fetch('https://api.rainviewer.com/public/weather-maps.json');
        const data=await res.json();
        radarFrames=data.radar.past.concat(data.radar.nowcast||[]);
        if(radarFrames.length){
            currentFrame=radarFrames.length-1;
            showRadarFrame(currentFrame);
        }
    }catch(err){console.error('Radar error:',err)}
}

function showRadarFrame(idx){
    if(!radarFrames.length)return;
    if(radarLayer)radarMap.removeLayer(radarLayer);
    const frame=radarFrames[idx];
    const url=`https://tilecache.rainviewer.com${frame.path}/256/{z}/{x}/{y}/2/1_1.png`;
    radarLayer=L.tileLayer(url,{opacity:.7}).addTo(radarMap);
    const time=new Date(frame.time*1000);
    document.getElementById('radarTime').textContent=time.toLocaleString('pt-BR');
}

function radarPrev(){if(currentFrame>0){currentFrame--;showRadarFrame(currentFrame)}}
function radarNext(){if(currentFrame<radarFrames.length-1){currentFrame++;showRadarFrame(currentFrame)}}
function toggleRadarPlay(){
    radarPlaying=!radarPlaying;
    document.getElementById('radarPlayBtn').innerHTML=radarPlaying?'<i class="fas fa-pause"></i>':'<i class="fas fa-play"></i>';
    if(radarPlaying){
        radarInterval=setInterval(()=>{
            currentFrame++;
            if(currentFrame>=radarFrames.length)currentFrame=0;
            showRadarFrame(currentFrame);
        },500);
    }else{clearInterval(radarInterval)}
}

function setRadarLayer(type){
    radarLayerType=type;
    document.querySelectorAll('.radar-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('btn-'+type).classList.add('active');
    // For satellite, would need different API endpoint
}

function getCondition(code){
    const c={0:{text:'Cielo despejado',icon:'fa-sun',color:'#fcd34d'},1:{text:'Pouco nublado',icon:'fa-sun',color:'#fcd34d'},2:{text:'Parcialmente nublado',icon:'fa-cloud-sun',color:'#fbbf24'},3:{text:'Nublado',icon:'fa-cloud',color:'#94a3b8'},45:{text:'Neblina',icon:'fa-smog',color:'#9ca3af'},48:{text:'Neblina',icon:'fa-smog',color:'#9ca3af'},51:{text:'Garoa',icon:'fa-cloud-rain',color:'#60a5fa'},53:{text:'Garoa',icon:'fa-cloud-rain',color:'#60a5fa'},55:{text:'Garoa forte',icon:'fa-cloud-rain',color:'#3b82f6'},61:{text:'Chuva leve',icon:'fa-cloud-rain',color:'#60a5fa'},63:{text:'Chuva',icon:'fa-cloud-showers-heavy',color:'#3b82f6'},65:{text:'Lluvia fuerte',icon:'fa-cloud-showers-heavy',color:'#1d4ed8'},66:{text:'Lluvia helada',icon:'fa-snowflake',color:'#7dd3fc'},67:{text:'Lluvia helada',icon:'fa-snowflake',color:'#7dd3fc'},71:{text:'Neve leve',icon:'fa-snowflake',color:'#e0f2fe'},73:{text:'Neve',icon:'fa-snowflake',color:'#bae6fd'},75:{text:'Nieve intensa',icon:'fa-snowflake',color:'#7dd3fc'},77:{text:'Granizo',icon:'fa-cloud-meatball',color:'#94a3b8'},80:{text:'Pancadas',icon:'fa-cloud-rain',color:'#60a5fa'},81:{text:'Pancadas',icon:'fa-cloud-showers-heavy',color:'#3b82f6'},82:{text:'Pancadas fortes',icon:'fa-cloud-showers-heavy',color:'#1d4ed8'},85:{text:'Neve',icon:'fa-snowflake',color:'#bae6fd'},86:{text:'Nieve intensa',icon:'fa-snowflake',color:'#7dd3fc'},95:{text:'Tempestade',icon:'fa-bolt',color:'#f59e0b'},96:{text:'Tempestade granizo',icon:'fa-cloud-bolt',color:'#f59e0b'},99:{text:'Tempestade granizo',icon:'fa-cloud-bolt',color:'#dc2626'}};
    return c[code]||{text:'--',icon:'fa-question',color:'#94a3b8'};
}

function setUnit(u){
    unit=u;
    document.querySelectorAll('.unit-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('btn-'+u).classList.add('active');
    if(forecastData){
        displayForecast(forecastData);
        displayCharts(forecastData,hourlyData);
        displayHourly48(hourlyData);
        if(document.getElementById('hourlyDetail').classList.contains('show'))showHourlyForDay(selectedDay);
    }
}

function c2f(c){return c!==null?(c*9/5)+32:null}
function logout(){sb.auth.signOut().then(()=>window.location.href='index.html')}
function toast(msg,type='info'){const t=document.createElement('div');t.className='toast '+type;t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),4000)}
</script>
</body>
</html>
